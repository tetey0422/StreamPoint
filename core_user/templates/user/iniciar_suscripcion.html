{% extends 'base.html' %}
{% load static %}

{% block title %}Comprar {{ plan.servicio.nombre }} - StreamPoint{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent">
                <li class="breadcrumb-item"><a href="{% url 'public:index' %}" class="text-light">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'public:catalogo' %}" class="text-light">Catálogo</a></li>
                <li class="breadcrumb-item"><a href="{% url 'public:detalle_servicio' plan.servicio.id %}" class="text-light">{{ plan.servicio.nombre }}</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">Comprar</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Resumen del Plan -->
    <div class="col-lg-7 mb-4">
        <div class="card-custom p-4">
            <h2 class="text-gradient mb-4">
                <i class="fas fa-shopping-cart me-2"></i>Iniciar Suscripción
            </h2>

            <!-- Información del servicio -->
            <div class="mb-4 p-3" style="background: rgba(99, 102, 241, 0.05); border-radius: 10px;">
                <div class="row align-items-center">
                    <div class="col-auto">
                        {% if plan.servicio.logo_url %}
                        <img src="{{ plan.servicio.logo_url }}" 
                             alt="{{ plan.servicio.nombre }}"
                             style="width: 80px; height: 80px; object-fit: contain;">
                        {% else %}
                        <i class="fas fa-play-circle" style="font-size: 4rem; color: var(--primary-color);"></i>
                        {% endif %}
                    </div>
                    <div class="col">
                        <h4 class="mb-1">{{ plan.servicio.nombre }}</h4>
                        <p class="text-muted mb-0">{{ plan.nombre }} - {{ plan.get_duracion_display }}</p>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <form method="post" id="suscripcionForm">
                {% csrf_token %}

                <!-- Email del servicio -->
                <div class="mb-4">
                    <label for="email_servicio" class="form-label-custom">
                        <i class="fas fa-envelope me-2"></i>Email para el servicio
                    </label>
                    <input type="email" 
                           class="form-control-custom" 
                           id="email_servicio"
                           name="email_servicio"
                           placeholder="ejemplo@email.com"
                           required>
                    <small class="text-muted d-block mt-1">
                        Email que usarás para acceder a {{ plan.servicio.nombre }}
                    </small>
                </div>

                <!-- Método de pago -->
                <div class="mb-4">
                    <label class="form-label-custom">
                        <i class="fas fa-credit-card me-2"></i>Método de Pago
                    </label>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check payment-option">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="metodo_pago" 
                                       id="tarjeta"
                                       value="tarjeta"
                                       checked>
                                <label class="form-check-label w-100" for="tarjeta">
                                    <div class="p-3 border rounded">
                                        <i class="fas fa-credit-card fa-2x mb-2 text-primary"></i>
                                        <h6>Tarjeta de Crédito/Débito</h6>
                                        <small class="text-muted">Pago instantáneo</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check payment-option">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="metodo_pago" 
                                       id="pse"
                                       value="pse">
                                <label class="form-check-label w-100" for="pse">
                                    <div class="p-3 border rounded">
                                        <i class="fas fa-university fa-2x mb-2 text-success"></i>
                                        <h6>PSE</h6>
                                        <small class="text-muted">Débito bancario</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check payment-option">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="metodo_pago" 
                                       id="efectivo"
                                       value="efectivo">
                                <label class="form-check-label w-100" for="efectivo">
                                    <div class="p-3 border rounded">
                                        <i class="fas fa-money-bill-wave fa-2x mb-2 text-success"></i>
                                        <h6>Efectivo</h6>
                                        <small class="text-muted">Puntos de pago</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check payment-option">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="metodo_pago" 
                                       id="puntos"
                                       value="puntos">
                                <label class="form-check-label w-100" for="puntos">
                                    <div class="p-3 border rounded">
                                        <i class="fas fa-coins fa-2x mb-2 text-warning"></i>
                                        <h6>Canje de Puntos</h6>
                                        <small class="text-muted">Usa tus puntos</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Términos y condiciones -->
                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="acepto_terminos" required>
                        <label class="form-check-label" for="acepto_terminos">
                            Acepto los <a href="#" class="text-primary">términos y condiciones</a> y 
                            <a href="#" class="text-primary">política de privacidad</a>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary-custom w-100 btn-lg">
                    <i class="fas fa-check me-2"></i>Confirmar Compra
                </button>
            </form>
        </div>
    </div>

    <!-- Resumen de Compra -->
    <div class="col-lg-5">
        <div class="card-custom p-4 mb-4" style="position: sticky; top: 20px;">
            <h4 class="mb-4">
                <i class="fas fa-receipt me-2"></i>Resumen de Compra
            </h4>

            <div class="mb-3 pb-3 border-bottom">
                <div class="d-flex justify-content-between mb-2">
                    <span>Plan:</span>
                    <strong>{{ plan.nombre }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Duración:</span>
                    <strong>{{ plan.get_duracion_display }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Días de acceso:</span>
                    <strong>{{ plan.get_duracion_dias }} días</strong>
                </div>
            </div>

            <div class="mb-3 pb-3 border-bottom">
                <div class="d-flex justify-content-between mb-2">
                    <span>Precio:</span>
                    <strong>${{ plan.precio|floatformat:0 }} COP</strong>
                </div>
                <div class="d-flex justify-content-between text-success">
                    <span>Descuento:</span>
                    <strong>$0 COP</strong>
                </div>
            </div>

            <div class="mb-4 pb-3 border-bottom">
                <div class="d-flex justify-content-between">
                    <strong>Total a Pagar:</strong>
                    <h4 class="text-primary mb-0">${{ plan.precio|floatformat:0 }}</h4>
                </div>
            </div>

            <!-- Puntos a ganar -->
            <div class="alert alert-warning mb-0">
                <h6 class="mb-2">
                    <i class="fas fa-gift me-2"></i>¡Ganarás Puntos!
                </h6>
                <p class="mb-2">Con esta compra ganarás:</p>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Primera compra:</span>
                    <strong class="text-warning">{{ plan.puntos_primera_compra }} puntos</strong>
                </div>
                <small class="d-block mt-2 text-muted">
                    Equivalente a ${{ plan.puntos_primera_compra|floatformat:0|divisibleby:10 }} COP para futuras compras
                </small>
            </div>
        </div>

        <!-- Info adicional -->
        <div class="card-custom p-4">
            <h6 class="mb-3">
                <i class="fas fa-info-circle me-2"></i>Información Importante
            </h6>
            <ul class="small text-muted mb-0">
                <li class="mb-2">Tu suscripción será activada en 24-48 horas</li>
                <li class="mb-2">Recibirás un email de confirmación</li>
                <li class="mb-2">Los puntos se acreditarán tras la validación</li>
                <li class="mb-2">Puedes renovar antes del vencimiento</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Estilo para opciones de pago seleccionadas
    document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.payment-option label > div').forEach(div => {
                div.classList.remove('border-primary', 'bg-light');
            });
            if (this.checked) {
                this.closest('.payment-option').querySelector('label > div').classList.add('border-primary', 'bg-light');
            }
        });
    });

    // Inicializar el seleccionado por defecto
    const checkedRadio = document.querySelector('input[name="metodo_pago"]:checked');
    if (checkedRadio) {
        checkedRadio.closest('.payment-option').querySelector('label > div').classList.add('border-primary', 'bg-light');
    }

    // Validación del formulario
    const form = document.getElementById('suscripcionForm');
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
