{% extends 'base.html' %}
{% load static %}

{% block title %}Validar Suscripción - StreamPoint Admin{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent">
                <li class="breadcrumb-item"><a href="{% url 'admin_custom:dashboard' %}" class="text-light">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'admin_custom:validar_suscripciones' %}" class="text-light">Validar Suscripciones</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">Detalle</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Información Detallada -->
    <div class="col-lg-7 mb-4">
        <div class="card-custom p-4">
            <h2 class="text-gradient mb-4">
                <i class="fas fa-file-invoice me-2"></i>Detalle de Suscripción
            </h2>

            <!-- Usuario -->
            <div class="mb-4 p-3" style="background: rgba(99, 102, 241, 0.05); border-radius: 10px;">
                <h5 class="mb-3">
                    <i class="fas fa-user me-2"></i>Información del Usuario
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Usuario:</strong> {{ suscripcion.usuario.username }}</p>
                        <p class="mb-2"><strong>Email:</strong> {{ suscripcion.usuario.email }}</p>
                        <p class="mb-0"><strong>Miembro desde:</strong> {{ suscripcion.usuario.date_joined|date:"d/m/Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Puntos actuales:</strong> {{ suscripcion.usuario.perfil.puntos_disponibles }}</p>
                        <p class="mb-2"><strong>Puntos totales:</strong> {{ suscripcion.usuario.perfil.puntos_totales }}</p>
                        <p class="mb-0"><strong>Suscripciones:</strong> {{ suscripcion.usuario.suscripciones.count }}</p>
                    </div>
                </div>
            </div>

            <!-- Servicio y Plan -->
            <div class="mb-4 p-3" style="background: rgba(16, 185, 129, 0.05); border-radius: 10px;">
                <h5 class="mb-3">
                    <i class="fas fa-tv me-2"></i>Servicio y Plan
                </h5>
                <div class="d-flex align-items-center mb-3">
                    {% if suscripcion.plan.servicio.logo_url %}
                    <img src="{{ suscripcion.plan.servicio.logo_url }}" 
                         alt="{{ suscripcion.plan.servicio.nombre }}"
                         style="width: 60px; height: 60px; object-fit: contain; margin-right: 15px;">
                    {% endif %}
                    <div>
                        <h5 class="mb-0">{{ suscripcion.plan.servicio.nombre }}</h5>
                        <p class="text-muted mb-0">{{ suscripcion.plan.servicio.categoria.nombre }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Plan:</strong> {{ suscripcion.plan.nombre }}</p>
                        <p class="mb-2"><strong>Duración:</strong> {{ suscripcion.plan.get_duracion_display }}</p>
                        <p class="mb-0"><strong>Días:</strong> {{ suscripcion.plan.get_duracion_dias }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Precio:</strong> ${{ suscripcion.monto_pagado|floatformat:0 }} COP</p>
                        <p class="mb-2"><strong>Método:</strong> {{ suscripcion.get_metodo_pago_display }}</p>
                        <p class="mb-0">
                            <strong>Tipo:</strong> 
                            {% if suscripcion.es_primera_compra %}
                                <span class="badge bg-success">Primera compra</span>
                            {% else %}
                                <span class="badge bg-info">Renovación</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Fechas -->
            <div class="mb-4 p-3" style="background: rgba(245, 158, 11, 0.05); border-radius: 10px;">
                <h5 class="mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>Fechas y Períodos
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-plus-circle me-2 text-success"></i>
                            <strong>Creada:</strong> {{ suscripcion.fecha_creacion|date:"d/m/Y H:i" }}
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-play-circle me-2 text-primary"></i>
                            <strong>Inicio:</strong> {{ suscripcion.fecha_inicio|date:"d/m/Y" }}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-stop-circle me-2 text-danger"></i>
                            <strong>Vencimiento:</strong> {{ suscripcion.fecha_vencimiento|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-envelope me-2"></i>
                            <strong>Email servicio:</strong><br>
                            <span class="small">{{ suscripcion.email_servicio }}</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Puntos -->
            <div class="alert alert-warning mb-4">
                <h6 class="mb-2">
                    <i class="fas fa-coins me-2"></i>Puntos a Otorgar
                </h6>
                <p class="mb-0">
                    Al aprobar esta suscripción, se otorgarán automáticamente 
                    <strong>
                        {% if suscripcion.es_primera_compra %}
                            {{ suscripcion.plan.puntos_primera_compra }}
                        {% else %}
                            {{ suscripcion.plan.puntos_renovacion }}
                        {% endif %}
                        puntos
                    </strong>
                    al usuario {{ suscripcion.usuario.username }}.
                </p>
            </div>

            {% if suscripcion.notas %}
            <div class="mb-4">
                <h6><i class="fas fa-sticky-note me-2"></i>Notas:</h6>
                <p class="text-muted">{{ suscripcion.notas }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Acciones -->
    <div class="col-lg-5">
        <div class="card-custom p-4 mb-4" style="position: sticky; top: 20px;">
            <h4 class="mb-4">
                <i class="fas fa-tasks me-2"></i>Acciones
            </h4>

            <!-- Aprobar -->
            <form method="post" class="mb-3">
                {% csrf_token %}
                <input type="hidden" name="accion" value="aprobar">
                
                <div class="alert alert-success border-0 mb-3">
                    <h6 class="mb-2">
                        <i class="fas fa-check-circle me-2"></i>Aprobar Suscripción
                    </h6>
                    <ul class="small mb-0 ps-3">
                        <li>La suscripción se marcará como ACTIVA</li>
                        <li>Se otorgarán los puntos al usuario</li>
                        <li>El usuario recibirá notificación</li>
                    </ul>
                </div>

                <button type="submit" class="btn btn-success w-100 btn-lg" onclick="return confirm('¿Estás seguro de aprobar esta suscripción?')">
                    <i class="fas fa-check-double me-2"></i>Aprobar Suscripción
                </button>
            </form>

            <hr>

            <!-- Rechazar -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="accion" value="rechazar">
                
                <div class="alert alert-danger border-0 mb-3">
                    <h6 class="mb-2">
                        <i class="fas fa-times-circle me-2"></i>Rechazar Suscripción
                    </h6>
                    <ul class="small mb-0 ps-3">
                        <li>La suscripción se marcará como CANCELADA</li>
                        <li>NO se otorgarán puntos</li>
                        <li>El usuario recibirá notificación</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="motivo" class="form-label-custom">
                        Motivo del rechazo:
                    </label>
                    <textarea class="form-control-custom" 
                              name="motivo" 
                              id="motivo" 
                              rows="3"
                              placeholder="Explica brevemente el motivo del rechazo..."
                              required></textarea>
                </div>

                <button type="submit" class="btn btn-danger w-100 btn-lg" onclick="return confirm('¿Estás seguro de rechazar esta suscripción?')">
                    <i class="fas fa-ban me-2"></i>Rechazar Suscripción
                </button>
            </form>

            <hr>

            <a href="{% url 'admin_custom:validar_suscripciones' %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
            </a>
        </div>

        <!-- Información adicional -->
        <div class="card-custom p-4">
            <h6 class="mb-3">
                <i class="fas fa-info-circle me-2"></i>Información Adicional
            </h6>
            <ul class="small text-muted mb-0">
                <li class="mb-2">Verifica que los datos del usuario sean correctos</li>
                <li class="mb-2">Confirma que el pago haya sido procesado</li>
                <li class="mb-2">Revisa el email del servicio</li>
                <li>Los puntos se acreditarán automáticamente al aprobar</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
