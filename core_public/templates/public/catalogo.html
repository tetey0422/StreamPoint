{% extends 'base.html' %}
{% load static %}

{% block title %}Catálogo - StreamPoint{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'public/css/public_styles.css' %}">
{% endblock %}

{% block content %}
<!-- Header Mejorado -->
<div class="catalog-header text-white">
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="display-3 fw-bold mb-3">
                <i class="fas fa-th me-3"></i>Catálogo de Servicios
            </h1>
            <p class="lead mb-4">
                Explora los mejores servicios de streaming con sistema de recompensas
            </p>
        </div>
        
        <!-- Barra de Búsqueda Fancy -->
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <form method="get" class="search-bar-fancy">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search text-muted ms-3 me-2"></i>
                        <input type="text" 
                               name="q" 
                               class="flex-grow-1"
                               placeholder="Buscar Netflix, Spotify, Disney+..."
                               value="{{ busqueda|default:'' }}">
                        <button type="submit" class="btn btn-primary-custom">
                            Buscar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Filtros de Categoría Mejorados -->
        <div class="text-center mt-4">
            <a href="{% url 'public:catalogo' %}" 
               class="category-pill {% if not categoria_seleccionada %}active{% endif %}">
                <i class="fas fa-globe me-2"></i>Todas
            </a>
            {% for categoria in categorias %}
            <a href="{% url 'public:catalogo' %}?categoria={{ categoria.id }}" 
               class="category-pill {% if categoria_seleccionada == categoria.id|stringformat:'s' %}active{% endif %}">
                <i class="fas {{ categoria.icono }} me-2"></i>{{ categoria.nombre }}
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<div class="container my-5">
    <!-- Resultados de Búsqueda -->
    {% if busqueda or categoria_seleccionada %}
        <div class="alert alert-info border-0 shadow-sm mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="fas fa-info-circle me-2"></i>
                    Mostrando <strong>{{ servicios.count }}</strong> resultado{{ servicios.count|pluralize }}
                    {% if busqueda %}
                        para "<strong>{{ busqueda }}</strong>"
                    {% endif %}
                </div>
                <a href="{% url 'public:catalogo' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-times me-2"></i>Limpiar filtros
                </a>
            </div>
        </div>
    {% endif %}

    <!-- Grid de Servicios MEJORADO -->
    <div class="row g-4 mb-5">
        {% if servicios %}
            {% for servicio in servicios %}
                <div class="col-md-6 col-lg-4 searchable-item">
                    <a href="{% url 'public:detalle_servicio' servicio.id %}" class="text-decoration-none">
                        <div class="card service-card-enhanced h-100">
                            <!-- Logo con efecto shimmer -->
                            <div class="service-logo-container">
                                <span class="plan-count-badge">
                                    <i class="fas fa-layer-group me-1"></i>
                                    {{ servicio.planes.count }} plan{{ servicio.planes.count|pluralize:"es" }}
                                </span>
                                {% if servicio.logo_url %}
                                    <img src="{{ servicio.logo_url }}" 
                                         alt="{{ servicio.nombre }}" 
                                         class="service-logo-enhanced">
                                {% else %}
                                    <i class="fas fa-play-circle service-logo-enhanced" 
                                       style="font-size: 5rem; color: var(--primary-color);"></i>
                                {% endif %}
                            </div>

                            <!-- Contenido -->
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h4 class="card-title mb-0">{{ servicio.nombre }}</h4>
                                    <span class="badge bg-primary">
                                        <i class="fas {{ servicio.categoria.icono }} me-1"></i>
                                        {{ servicio.categoria.nombre }}
                                    </span>
                                </div>
                                
                                <p class="text-muted mb-3">
                                    {{ servicio.descripcion|truncatewords:15 }}
                                </p>
                                
                                <!-- Precio desde -->
                                {% with primer_plan=servicio.planes.all.first %}
                                {% if primer_plan %}
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted d-block">Desde</small>
                                        <h5 class="text-success mb-0">
                                            ${{ primer_plan.precio|floatformat:0 }} COP
                                        </h5>
                                    </div>
                                    <div class="text-end">
                                        <span class="points-badge-enhanced">
                                            <i class="fas fa-star me-1"></i>
                                            +{{ primer_plan.puntos_primera_compra }} pts
                                        </span>
                                    </div>
                                </div>
                                {% endif %}
                                {% endwith %}
                            </div>
                            
                            <!-- Footer -->
                            <div class="card-footer bg-transparent border-top-0 p-4 pt-0">
                                <button class="btn btn-primary-custom w-100">
                                    <i class="fas fa-eye me-2"></i>Ver Planes
                                </button>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        {% else %}
            <!-- No hay servicios -->
            <div class="col-12">
                <div class="card-custom text-center p-5">
                    <i class="fas fa-search" style="font-size: 5rem; color: var(--text-light); margin-bottom: 30px;"></i>
                    <h3 class="text-white mb-3">No se encontraron servicios</h3>
                    <p class="text-muted mb-4">
                        No hay servicios disponibles con los filtros seleccionados.
                        Prueba con otros términos o categorías.
                    </p>
                    <a href="{% url 'public:catalogo' %}" class="btn btn-primary-custom btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Ver todos los servicios
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Información sobre Puntos FANCY -->
    <div class="info-section-fancy">
        <div class="text-center mb-5">
            <i class="fas fa-star fa-3x mb-3"></i>
            <h2 class="display-5 fw-bold mb-3">Sistema de Puntos</h2>
            <p class="lead">Gana recompensas con cada compra</p>
        </div>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <h2>100</h2>
                    <h5>Puntos</h5>
                    <p class="mb-0">Primera Compra</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="fas fa-sync fa-3x mb-3"></i>
                    <h2>50</h2>
                    <h5>Puntos</h5>
                    <p class="mb-0">Cada Renovación</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="fas fa-gift fa-3x mb-3"></i>
                    <h2>10</h2>
                    <h5>Puntos</h5>
                    <p class="mb-0">= $1 COP</p>
                </div>
            </div>
        </div>
        
        {% if not user.is_authenticated %}
        <div class="text-center mt-5">
            <a href="{% url 'user:registro' %}" class="btn btn-light btn-lg px-5">
                <i class="fas fa-user-plus me-2"></i>Regístrate para Empezar
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Estadísticas del Catálogo -->
    <div class="row mt-5">
        <div class="col-md-4 mb-4">
            <div class="card-custom text-center p-4">
                <div class="stat-value counter-animate" data-target="{{ servicios.count }}">0</div>
                <div class="stat-label">Servicios Disponibles</div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card-custom text-center p-4">
                <div class="stat-value counter-animate" data-target="{{ categorias.count }}">0</div>
                <div class="stat-label">Categorías</div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card-custom text-center p-4">
                <div class="stat-value counter-animate" data-target="10">0</div>
                <div class="stat-label">Puntos por Peso</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'public/js/public_scripts.js' %}"></script>
<script>
    // Mensaje "no hay resultados" dinámico
    const grid = document.querySelector('.row.g-4');
    if (grid && !document.getElementById('noResultsMessage')) {
        const noResultsDiv = document.createElement('div');
        noResultsDiv.id = 'noResultsMessage';
        noResultsDiv.className = 'col-12';
        noResultsDiv.style.display = 'none';
        noResultsDiv.innerHTML = `
            <div class="card-custom text-center p-5">
                <i class="fas fa-search" style="font-size: 4rem; color: var(--text-light); margin-bottom: 20px;"></i>
                <h4 class="text-white">No se encontraron servicios</h4>
                <p class="text-muted">Intenta con otro término de búsqueda.</p>
            </div>
        `;
        grid.appendChild(noResultsDiv);
    }
</script>
{% endblock %}